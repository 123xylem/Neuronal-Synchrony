<!doctype html>
<html>
  <head>
    <title>Neuronal Synchrony</title>
    <link rel="stylesheet" media="screen" type="text/css" href="./styles/base.css" />
  </head>
  <body>
    <canvas id="stage" width="100%" height="100%"></canvas>
    <script type="text/javascript" src="./third-party/require.js"></script>
    <script type="text/javascript">

      var _root = window;

      /**
       * Settings
       */

      require({
        baseUrl: './src',
        jQuery: false,
        paths: {
          'underscore': '../third-party/underscore',
          'physics': '../third-party/physics'
        }
      });

      /**
       * Initialize stage
       */

      require([
        'dom/dom',
        'utils/urlArgs',
        'utils/requestAnimationFrame',
        '../third-party/physics/src/Vector',
        'animation/Tween',
        'underscore'
      ], function(dom, urlArgs, requestAnimationFrame, Vector, Tween) {

        var filename = urlArgs['sketches'].replace(/\/$/, '');

        if (!filename) {
          return;
        }

        var canvas = document.querySelector('#stage');
        var loops = [];

        _root.stage = {
          ctx: canvas.getContext('2d'),
          domElement: canvas,
          mouse: new Vector(),
          center: new Vector(),
          draw: function(func) {
            if (_.isFunction(func)) {
              loops.push(func);
            }
          }
        };

        dom
          .bind(window, 'mousemove', updateMouse)
          .bind(window, 'resize', stageResize)
          .loadScript('script', {
            type: 'text/javascript',
            src: './sketches/' + filename + '.js'
          });
        stageResize();
        loop();

        function loop() {

          stage.ctx.clearRect(0, 0, stage.width, stage.height);

          requestAnimationFrame(loop);
          Tween.tick();
          // _.each(loops, function(loop) {
          //   loop.call(this);
          // }, stage);

        }

        function updateMouse(e) {

          stage.mouse.set(e.pageX, e.pageY);

        }

        function stageResize() {

          var width = stage.width = window.innerWidth;
          var height = stage.height = window.innerHeight;

          var canvas = stage.domElement;

          canvas.width = width;
          canvas.height = height;

          stage.center.set(width / 2, height / 2);

          _.extend(canvas.style, {
            width: width + 'px',
            height: height + 'px'
          });

        }

      });

    </script>
  </body>
</html>
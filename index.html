<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Patatap</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <link href='//fonts.googleapis.com/css?family=Inconsolata:700,400' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" media="screen" type="text/css" href="./styles/main.css" />
    <link rel="icon" type="image/png" href="./images/favicon.png" />
  </head>
  <body>
    <div id="content">
    </div>
    <div id="lobby">
      <div id="loader"></div>
      <div id="asset-info">
        <span id="loaded">0</span> / <span id="total-assets">130</span>
      </div>
    </div>
    <div class="scripts" style="display: none;">
      <script src="./third-party/has.js"></script>
      <script src="./third-party/url.js"></script>
      <script src="./third-party/jquery.js"></script>
      <script src="./third-party/tween.js"></script>
      <script src="./third-party/two.js"></script>
      <script src="./src/sound.js"></script>
      <script src="./src/animations.js"></script>
      <script>

        $(function() {

          var container = $('#content'), $window, ui, buttons, width, height,
            landscape;

          /**
           * Append Sound Generation to Animations
           */

          var letters = ['A', 'B', 'C', 'D', 'E'];
          var path = './assets/', filetype = '.mp3';
          var asset_count = 0, $loaded = $('#loaded');

          $('#total-assets').html(26 * letters.length);

          var soundsBuffered = _.after(26 * letters.length, function() {
            if (url.loop && url.loop.match(/(clap|groove)/ig)) {
              new Sound('./assets/' + url.loop.replace(/\//ig, '') + '-loop' + filetype, function() {
                this.play({
                  loop: true
                });
              });
              initialize();
              return;
            }
            initialize();
          });

          Sound.ready(function() {
            _.each(animations.list, function(a, i) {
              if (a.filename) {
                a.sounds = _.map(letters, function(type) {
                  return new Sound(path + type + '/' + a.filename + filetype, function() {
                    asset_count++;
                    $loaded.html(asset_count);
                    soundsBuffered();
                  });
                });
              }
            });
          });

          function initialize() {

            animations.initializeSound();

            $window = $(window)
              // Disable scrolling
              .bind('touchstart touchmove touchend touchcancel', function(e) {
                e.preventDefault();
                return false;
              })
              .bind('keydown', function(e, data) {

                e.preventDefault();
                var code = e.which || data;
                var index;

                switch (code) {

                  // Q - P
                  case 81:
                    index = '0,0';
                    break;
                  case 87:
                    index = '0,1';
                    break;
                  case 69:
                    index = '0,2';
                    break;
                  case 82:
                    index = '0,3';
                    break;
                  case 84:
                    index = '0,4';
                    break;
                  case 89:
                    index = '0,5';
                    break;
                  case 85:
                    index = '0,6';
                    break;
                  case 73:
                    index = '0,7';
                    break;
                  case 79:
                    index = '0,8';
                    break;
                  case 80:
                    index = '0,9';
                    break;

                  // A - L
                  case 65:
                    index = '1,0';
                    break;
                  case 83:
                    index = '1,1';
                    break;
                  case 68:
                    index = '1,2';
                    break;
                  case 70:
                    index = '1,3';
                    break;
                  case 71:
                    index = '1,4';
                    break;
                  case 72:
                    index = '1,5';
                    break;
                  case 74:
                    index = '1,6';
                    break;
                  case 75:
                    index = '1,7';
                    break;
                  case 76:
                    index = '1,8';
                    break;

                  // Z - M
                  case 90:
                    index = '2,0';
                    break;
                  case 88:
                    index = '2,1';
                    break;
                  case 67:
                    index = '2,2';
                    break;
                  case 86:
                    index = '2,3';
                    break;
                  case 66:
                    index = '2,4';
                    break;
                  case 78:
                    index = '2,5';
                    break;
                  case 77:
                    index = '2,6';
                    break;
                  case 188:
                    index = '2,7';
                    break;

                  // SPACE
                  case 32:
                    index = '3,0';
                    break;

                }

                trigger(index);

              });

            if (has.mobile) {
              createMobileUI();
            }

            two
              .bind('resize', orientUserInterface)
              .bind('update', function() {

                TWEEN.update();
                animations.update();

                if (!ui) {
                  return;
                }

                _.each(buttons.needsUpdate, updateButtons);

                ui.update();

              }).play();

            _.delay(function() {
              $('#lobby').fadeOut();
            }, 1000);

          }

          function createMobileUI() {

            ui = new Two({
              fullscreen: true
            }).appendTo(container[0]);

            ui.renderer.domElement.id = 'ui';

            buttons = [];
            buttons.width = buttons.height = 32;
            buttons.needsUpdate = {};
            buttons.map = {};

            buttons[0] = _.map(_.range(10), createButton, ui);
            buttons[1] = _.map(_.range(9), createButton, ui);
            buttons[2] = _.map(_.range(8), createButton, ui);

            var rows = 3;

            ui.update();

            var touches = [], e, x, y, row, index;

            var getIndex = function(x, y) {
              if (landscape) {
                row = Math.max(Math.floor(y / buttons.height), 0);
                return row + ','
                  + Math.max(Math.floor(x / buttons.height), 0);
              }
              row = Math.max(Math.floor(x / buttons.width), 0);
              return row + ','
                + Math.max(Math.floor(y / buttons.height), 0);
            };

            var startTouchEnter = function(touch) {
              x = touch.clientX;
              y = touch.clientY;
              touches[touch.identifier] = getIndex(x, y);
            };

            var updateTouchEnter = function(touch) {
              x = touch.clientX;
              y = touch.clientY;
              index = getIndex(x, y);
              if (touches[touch.identifier] && touches[touch.identifier] !== index) {
                triggerButton(index, buttons.map[index]);
                touches[touch.identifier] = index;
              }
            };

            var triggerButton = function(index, button) {

              trigger(index);

              if (animations.getColorPalette().isDark) {
                button.fill = 'rgba(255, 255, 255, 0.3)';
              } else {
                button.fill = 'rgba(0, 0, 0, 0.3)';
              }

              button.opacity = 1.0;
              buttons.needsUpdate[button.id] = button;

            };

            $window
              .bind('touchstart', function(event) {

                e = event.originalEvent;
                _.each(e.touches, startTouchEnter);

              })
              .bind('touchmove', function(event) {

                e = event.originalEvent;
                _.each(e.touches, updateTouchEnter);

              });

            _.each(buttons, function(group, i) {

              _.each(group, function(button, j) {

                var elem = button._renderer.elem;
                var index = i + ',' + j;

                buttons.map[index] = button;

                $(elem)
                  .css({
                    cursor: 'pointer'
                  })
                  .bind('mousedown touchstart', function(event) {

                    e = event.originalEvent;
                    triggerButton(index, button);

                  });

              });

            });

            orientUserInterface();

          }

          function createButton() {

            var shape = this.makeRectangle(0, 0, buttons.width, buttons.height);
            shape.noFill().noStroke();
            // shape.fill = 'rgba(0, 0, 0, 0.1)';
            // shape.stroke = 'rgba(0, 0, 0, 0.1)';
            shape.opacity = 0;
            shape.visible = false;
            return shape;

          }

          function orientUserInterface() {

            if (!ui) {
              return;
            }

            width = $window.width();
            height = $window.height();
            landscape = width >= height;
            var size = buttons.length;

            _.each(buttons, function(group, i) {

              var length = group.length;
              var w, h, w2, h2, x, y;

              if (landscape) {
                w = width / length;
                h = height / size;
              } else {
                w = width / size;
                h = height / length;
              }

              buttons.width = w;
              buttons.height = h;

              w /= 2;
              h /= 2;

              _.each(group, function(button, j) {

                var vertices = button.vertices;

                if (landscape) {
                  x = width * (j + 0.5) / length;
                  y = height * (i + 0.5) / size;
                } else {
                  x = width * (i + 0.5) / size;
                  y = height * (j + 0.5) / length;
                }

                vertices[0].set(- w, - h);
                vertices[1].set(w, - h);
                vertices[2].set(w, h);
                vertices[3].set(- w, h);

                button.translation.set(x, y);
                button.visible = true;

              });

            });

          }

          function updateButtons(button, i) {

            button.opacity += (- button.opacity) * 0.2;

            if (button.opacity <= 0.1) {
              button.opacity = 0;
              delete buttons.needsUpdate[button.id];
            }

          }

          function trigger(index) {

            var animation = animations.map[index];

            if (animation) {
              if (animation.playing()) {
                animation.clear();
              }
              animation.start();
            }

          }

        });

      </script>
      <script>

        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-5927630-17', 'jonobr1.github.io');
        ga('send', 'pageview');

      </script>
    </div>
  </body>
</html>